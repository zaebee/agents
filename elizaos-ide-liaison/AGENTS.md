# Agent Guidelines for ElizaOS IDE Liaison Extension

Hello Jules (or other AI Agent)! This document provides guidance for working on the `elizaos-ide-liaison` VS Code extension codebase.

## Project Structure

*   **`src/`**: Contains all TypeScript source code.
    *   `extension.ts`: Main activation point, command registration, and wiring of components.
    *   `mcpClient.ts`: Handles all communication (sending requests, receiving SSE events) with the ElizaOS MCP server.
    *   `mcpInterfaces.ts`: Defines TypeScript interfaces for MCP messages and related data structures.
    *   `sadsPanelViewProvider.ts`: Manages the webview panel ("Agent Chat") displayed in the VS Code sidebar. Handles rendering of messages and user interactions within the panel.
*   **`media/`**: Static assets for the webview.
    *   `sadsPanel.html`: The HTML structure for the webview panel. (Note: currently, its content is largely embedded as a string within `sadsPanelViewProvider.ts` for simplicity, but the original file exists here).
    *   `elizaos-icon.svg`: Icon for the activity bar.
*   **`out/`**: Compiled JavaScript output (generated by `tsc`). Not committed to VCS.
*   **`package.json`**: Extension manifest, dependencies, scripts.
*   **`tsconfig.json`**: TypeScript compiler configuration.
*   **`README.md`**: User-facing documentation.

## Key Components & Logic Flow

1.  **Activation (`extension.ts`)**:
    *   Registers commands (e.g., "Ask Jules to Explain").
    *   Initializes `McpClient` for server communication.
    *   Initializes `SadsPanelViewProvider` for the UI panel.
    *   Connects `McpClient.onMessage` events to `SadsPanelViewProvider.handleMcpMessage` to display agent responses.

2.  **Command Execution (e.g., Explain Code)**:
    *   User triggers command (context menu, command palette).
    *   Command handler in `extension.ts` is invoked.
    *   Selected text and language ID are retrieved.
    *   User's query is displayed in the SADS panel via `sadsProvider.postMessageToPanel()`.
    *   An MCP `REQUEST` message is constructed (see `mcpInterfaces.ts` for payload structures).
    *   `mcpClient.sendRequest()` sends the message to the configured agent and ontology.
    *   A `conversation_id` is generated and passed to the SADS panel to track the interaction.

3.  **Receiving Messages (`mcpClient.ts`)**:
    *   `EventSource` connects to the `/mcp-events` endpoint.
    *   On receiving an SSE message, it's parsed as JSON into an `McpMessage`.
    *   The message is emitted via the `onMessage` event emitter.

4.  **Displaying Messages (`sadsPanelViewProvider.ts`)**:
    *   `handleMcpMessage` receives messages from `McpClient`.
    *   It formats the message content based on the `performative` (e.g., `INFORM_RESULT`, `ACCEPT`, `FAILURE`).
    *   `postMessageToPanel` sends the formatted data to the webview's JavaScript, which updates the `chat-history` div.

## Development Workflow

*   **Prerequisites**: Node.js, npm.
*   **Install Dependencies**: `npm install`
*   **Compile**: `npm run compile`
*   **Watch Mode**: `npm run watch` (for continuous compilation during development)
*   **Run Extension**: Open the `elizaos-ide-liaison` directory in VS Code and press `F5`. This opens an Extension Development Host window.
*   **Testing**:
    *   Manual testing is the primary method for now.
    *   You'll need a mock or actual ElizaOS MCP server running that can respond to requests on the configured endpoints (e.g., `http://localhost:8000/mcp-request` and `/mcp-events`).
    *   The server should understand the ontologies: `elizaos:ide:explain_code`, `elizaos:ide:get_documentation`, `elizaos:ide:refactor_suggestion`.
    *   Check VS Code's Developer Tools (Help > Toggle Developer Tools) in both the main window and the Extension Development Host window for console logs and errors.

## Key Ontologies and Payloads

Refer to `mcpInterfaces.ts` for detailed payload structures. Key ontologies used:
*   `elizaos:ide:explain_code`
*   `elizaos:ide:get_documentation`
*   `elizaos:ide:refactor_suggestion`

## Potential Future Enhancements (If you're asked to improve this)

*   **Applying Refactorings:** Currently, refactorings are only displayed. Implementing a way to apply them (e.g., via diffs) would be a major feature.
*   **Streaming Responses:** For long explanations or results, the agent might stream partial results. The SSE connection is suitable for this, but the panel logic would need to handle partial updates.
*   **Markdown Rendering:** Agent responses could be Markdown. The panel would need a Markdown renderer.
*   **More Sophisticated Error Handling/Display:** More granular error display or retry mechanisms.
*   **Dynamic Agent Discovery:** Instead of hardcoding agent IDs in settings, discover available agents and their capabilities from the MCP server.
*   **Authentication:** If the MCP server requires auth, implement it in `McpClient`.
*   **Unit/Integration Tests:** Implement automated tests.

## Coding Conventions

*   Follow standard TypeScript best practices.
*   Use ESLint for linting (config in `package.json`).
*   Keep MCP interaction logic within `McpClient`.
*   Keep UI/webview logic within `SadsPanelViewProvider` and `sadsPanel.html`.
*   Ensure configuration settings in `package.json` are up-to-date with how they are used.

Remember to update this `AGENTS.md` if you make significant architectural changes!
Good luck!
