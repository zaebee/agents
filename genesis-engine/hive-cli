#!/usr/bin/env python3

import argparse
import sys
import os

# Add project root to path before other imports
# This ensures that dna_core and other modules can be found
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from dna_core.royal_jelly import PeriodicTable

# --- Command Handlers ---

def handle_table_command(args):
    """Display the Hive's Periodic Table."""
    print("Summoning the Periodic Table of Primitives...")
    PeriodicTable.print_table()

def handle_compat_command(args):
    """Check if two primitives can bond."""
    print(f"üî¨ Compatibility Check: {args.element1} + {args.element2}")

    # This is a simplified check based on the new SDK
    # A real implementation might be more complex
    is_compatible = PeriodicTable.predict_compatibility(args.element1, args.element2)
    toxicity1 = PeriodicTable.check_toxicity(args.element1)
    toxicity2 = PeriodicTable.check_toxicity(args.element2)

    print(f"   ‚úÖ Compatible: {'Yes' if is_compatible else 'No'}")
    print(f"   ‚ö†Ô∏è Toxicity: {args.element1} ({toxicity1}), {args.element2} ({toxicity2})")

    if "high" in [toxicity1, toxicity2]:
        print("   üíÄ Warning: High toxicity detected! This bond is unstable and not recommended.")

def handle_unimplemented(args):
    """Handler for commands that are defined in the Grimoire but not yet implemented."""
    print(f"Command '{args.command}' is defined in the Grimoire but not yet implemented.")
    print("The Hive's magic is still growing. Check back later!")

# --- Main CLI Setup ---

def main():
    """Main entry point for the Alchemist's CLI."""
    parser = argparse.ArgumentParser(
        description="üìú The Beekeeper‚Äôs Grimoire: A CLI for tending to the Hive.",
        formatter_class=argparse.RawTextHelpFormatter
    )
    subparsers = parser.add_subparsers(dest="command", required=True, help="Available spells")

    # --- `table` command ---
    table_parser = subparsers.add_parser("table", help="Display the Hive's Periodic Table of Primitives.")
    table_parser.set_defaults(func=handle_table_command)

    # --- `compat` command ---
    compat_parser = subparsers.add_parser("compat", help="Check the chemical compatibility of two primitives.")
    compat_parser.add_argument("element1", help="The name of the first primitive (e.g., OrderAggregate)")
    compat_parser.add_argument("element2", help="The name of the second primitive (e.g., OrderPlacedEvent)")
    compat_parser.set_defaults(func=handle_compat_command)

    # --- Placeholder commands from the Grimoire ---
    # This makes the CLI aware of future commands and provides a helpful message.
    placeholder_commands = [
        "synthesize", "inspect", "cull", "observe", "advise", "feed",
        "plant", "harvest", "archive", "cure", "refine", "analyze",
        "list", "health", "history", "plan"
    ]
    for command in placeholder_commands:
        placeholder_parser = subparsers.add_parser(command, help=f"(Not yet implemented) See Grimoire for details on '{command}'.")
        placeholder_parser.set_defaults(func=handle_unimplemented)

    args = parser.parse_args()

    # Execute the function associated with the chosen sub-command
    if hasattr(args, 'func'):
        args.func(args)
    else:
        parser.print_help()

if __name__ == "__main__":
    main()
